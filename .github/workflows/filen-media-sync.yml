name: ðŸ“ Filen Media Sync
on:
  schedule:
    - cron: '*/30 * * * *'   # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚
  workflow_dispatch:         # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  repository_dispatch:
    types: [filen-media-changed]

jobs:
  sync-media:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Install Filen CLI
        run: |
          echo "ðŸ“¦ Installing Filen CLI..."
          curl -fsSL https://cdn.filen.io/cli/linux_amd64.tar.gz | tar -xz
          sudo mv filen /usr/local/bin/
          chmod +x /usr/local/bin/filen
          filen --version

      - name: ðŸ” Setup Filen credentials
        env:
          FILEN_EMAIL: ${{ secrets.FILEN_EMAIL }}
          FILEN_PASSWORD: ${{ secrets.FILEN_PASSWORD }}
          FILEN_2FA_CODE: ${{ secrets.FILEN_2FA_CODE }}
        run: |
          echo "ðŸ”‘ Creating credentials file..."
          echo "$FILEN_EMAIL" > .filen-cli-credentials
          echo "$FILEN_PASSWORD" >> .filen-cli-credentials
          echo "${FILEN_2FA_CODE:-XXXXXX}" >> .filen-cli-credentials

      - name: ðŸ“‚ Create local directories
        run: |
          echo "ðŸ“ Creating local media directories..."
          mkdir -p src/assets/img/equipment
          mkdir -p src/assets/img/team
          mkdir -p src/assets/img/cases
          mkdir -p src/assets/img/logos
          mkdir -p src/assets/docs
          mkdir -p src/assets/videos
          mkdir -p src/assets/thumbs

      - name: â¬‡ï¸ Download media from Filen
        run: |
          echo "ðŸ”„ Syncing media files from Filen..."
          
          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ (Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÐµÑÐ»Ð¸ Ð¿Ð°Ð¿ÐºÐ¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚)
          echo "ðŸ“¸ Equipment images..."
          filen download --remote "/service-moscow/images/equipment" --local "src/assets/img/equipment" --overwrite || echo "âš ï¸ Equipment folder not found"
          
          echo "ðŸ‘¥ Team images..."
          filen download --remote "/service-moscow/images/team" --local "src/assets/img/team" --overwrite || echo "âš ï¸ Team folder not found"
          
          echo "ðŸ“‹ Case studies..."
          filen download --remote "/service-moscow/images/cases" --local "src/assets/img/cases" --overwrite || echo "âš ï¸ Cases folder not found"
          
          echo "ðŸ·ï¸ Logos and icons..."
          filen download --remote "/service-moscow/images/logos" --local "src/assets/img/logos" --overwrite || echo "âš ï¸ Logos folder not found"
          
          echo "ðŸ“„ Documents..."
          filen download --remote "/service-moscow/documents" --local "src/assets/docs" --overwrite || echo "âš ï¸ Documents folder not found"
          
          echo "ðŸŽ¬ Videos..."
          filen download --remote "/service-moscow/videos" --local "src/assets/videos" --overwrite || echo "âš ï¸ Videos folder not found"

      - name: ðŸ–¼ï¸ Optimize images
        run: |
          echo "ðŸŽ¨ Installing image optimization tools..."
          sudo apt-get update -qq
          sudo apt-get install -y webp imagemagick > /dev/null 2>&1
          
          echo "âœ¨ Optimizing images..."
          
          # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸
          optimize_images() {
            local dir="$1"
            local max_width="$2"
            local quality="$3"
            
            if [[ -d "$dir" ]]; then
              find "$dir" -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | while read img; do
                # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ WebP Ð²ÐµÑ€ÑÐ¸ÑŽ
                webp_name="${img%.*}.webp"
                if [[ ! -f "$webp_name" ]]; then
                  cwebp -q "$quality" "$img" -o "$webp_name" 2>/dev/null && echo "ðŸ–¼ï¸  $(basename "$webp_name")"
                fi
                
                # Ð ÐµÑÐ°Ð¹Ð· ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ (ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»)
                if [[ -n "$max_width" ]]; then
                  convert "$img" -resize "${max_width}x${max_width}>" "$img" 2>/dev/null || true
                fi
              done
            fi
          }
          
          # ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ Ñ Ñ€Ð°Ð·Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸
          optimize_images "src/assets/img/equipment" "1280" "85"
          optimize_images "src/assets/img/team" "800" "90"
          optimize_images "src/assets/img/cases" "1600" "80"
          optimize_images "src/assets/img/logos" "512" "95"

      - name: ðŸ“‹ Generate media manifest
        run: |
          echo "ðŸ“„ Generating media manifest..."
          cat > src/assets/media-manifest.json << EOF
          {
            "generated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "sync_source": "filen",
            "folders": {
              "equipment": $(find src/assets/img/equipment -type f -name "*" 2>/dev/null | jq -R -s -c 'split("\n")[:-1] | map(split("/")[-1])' || echo '[]'),
              "team": $(find src/assets/img/team -type f -name "*" 2>/dev/null | jq -R -s -c 'split("\n")[:-1] | map(split("/")[-1])' || echo '[]'),
              "cases": $(find src/assets/img/cases -type f -name "*" 2>/dev/null | jq -R -s -c 'split("\n")[:-1] | map(split("/")[-1])' || echo '[]'),
              "logos": $(find src/assets/img/logos -type f -name "*" 2>/dev/null | jq -R -s -c 'split("\n")[:-1] | map(split("/")[-1])' || echo '[]'),
              "documents": $(find src/assets/docs -type f -name "*" 2>/dev/null | jq -R -s -c 'split("\n")[:-1] | map(split("/")[-1])' || echo '[]'),
              "videos": $(find src/assets/videos -type f -name "*" 2>/dev/null | jq -R -s -c 'split("\n")[:-1] | map(split("/")[-1])' || echo '[]')
            }
          }
          EOF

      - name: ðŸ“Š Show sync summary
        run: |
          echo "ðŸ“ˆ Sync Summary:"
          echo "Equipment: $(find src/assets/img/equipment -type f 2>/dev/null | wc -l) files"
          echo "Team: $(find src/assets/img/team -type f 2>/dev/null | wc -l) files"
          echo "Cases: $(find src/assets/img/cases -type f 2>/dev/null | wc -l) files"
          echo "Logos: $(find src/assets/img/logos -type f 2>/dev/null | wc -l) files"
          echo "Documents: $(find src/assets/docs -type f 2>/dev/null | wc -l) files"
          echo "Videos: $(find src/assets/videos -type f 2>/dev/null | wc -l) files"

      - name: ðŸ“ Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add src/assets/
          
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "ðŸ”„ Auto-sync: Update media from Filen.io
            
            - Updated media files from Filen cloud storage
            - Optimized images (WebP conversion, resizing)
            - Generated media manifest
            - Sync completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            
            git push
            echo "âœ… Changes committed and pushed"
          fi

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f .filen-cli-credentials
          echo "ðŸ§¹ Cleanup completed"

      - name: ðŸ“¢ Notify success (optional)
        if: success() && env.TG_BOT_TOKEN != ''
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          MESSAGE="âœ… Filen media sync completed for service.moscow
          
          ðŸ“Š Files synced:
          ðŸ”§ Equipment: $(find src/assets/img/equipment -type f 2>/dev/null | wc -l)
          ðŸ‘¥ Team: $(find src/assets/img/team -type f 2>/dev/null | wc -l)  
          ðŸ“‹ Cases: $(find src/assets/img/cases -type f 2>/dev/null | wc -l)
          ðŸ·ï¸ Logos: $(find src/assets/img/logos -type f 2>/dev/null | wc -l)
          
          ðŸ• $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          curl -s "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d text="$MESSAGE" > /dev/null || true